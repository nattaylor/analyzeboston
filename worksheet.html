<!--
    http://docs.ckan.org/en/latest/maintaining/datastore.html#the-datastore-api
 - Scrape schema: `SELECT * FROM "" LIMIT 1;` response.result.fields ex {type: "text", id: "year"}
    - default transforms (e.g. into decimals, etc)
    - add typeahead
    - https://data.boston.gov/api/3/action/package_list?limit=150 -> https://data.boston.gov/api/3/action/datastore_search?id=6ddcd912-32a0-43df-9908-63574f8c7e77&limit=0
    - https://data.boston.gov/api/3/action/package_search?q=*:*&rows=150&
    - transform hints: nullif('','')::decimal
 - Errors
    - look at the response.success property
    - display the error!
 - Download as CSV/TSV
 - Copy to clipboard
 - History
    - show query history    
{
    "help": "https://data.boston.gov/api/3/action/help_show?name=datastore_search_sql",
    "success": false,
    "error": {
        "info": {
            "params": [{}],
            "statement": ["SELECT\n    *\nFROM \"approved-building-permits\"\nLIMIT 1;"],
            "orig": ["relation \"approved-building-permits\" does not exist\nLINE 3: FROM \"approved-building-permits\"\n             ^\n"]
        },
        "query": ["(ProgrammingError) relation \"approved-building-permits\" does not exist\nLINE 3: FROM \"approved-building-permits\"\n             ^\n 'SELECT\\n    *\\nFROM \"approved-building-permits\"\\nLIMIT 1;' {}"],
        "__type": "Validation Error"
    }
}

{
    "help": "https://data.boston.gov/api/3/action/help_show?name=datastore_search_sql",
    "success": true,
    "result": {
        "records": [{
            "Parcel_ID": "2012032000",
            "Comments": "Change connector link layout from attached enclosed walkway to partially enclose walkway with canopy.",
            "Location": "(42.260750000, -71.149610000)",
            "PermitNumber": "A100071",
            "PermitTypeDescr": "Amendment to a Long Form",
            "ISSUED_DATE": "2011-11-04T11:04:58",
            "sq_feet": "170",
            "TOTAL_FEES": "429.00",
            "EXPIRATION_DATE": "2012-05-04 00:00:00",
            "WORKTYPE": "COB",
            "STATUS": "Open",
            "ZIP": "02132",
            "APPLICANT": "Renee Santeusanio",
            "STATE": "MA",
            "DECLARED_VALUATION": "40000.00",
            "CITY": "West Roxbury",
            "DESCRIPTION": "City of Boston",
            "_full_text": "'-04':31,37 '-05':36 '-11':30 '-71.149610000':58 '00':38,39,40 '02132':54 '04':33 '11':32 '170':46 '17268':55 '175':47 '2011':29 '2012':35 '2012032000':56 '40000.00':27 '42.260750000':57 '429.00':28 '58':34 'a':5 'a100071':1 'amendment':3 'attached':16 'boston':10,44 'boundary':49 'canopy':24 'change':11 'city':8,42 'cob':2 'comm':45 'connector':12 'enclose':21 'enclosed':17 'form':7 'from':15 'layout':14 'link':13 'long':6 'ma':53 'of':9,43 'open':41 'partially':20 'rd':50 'renee':25 'roxbury':52 'santeusanio':26 'to':4,19 'w':48 'walkway':18,22 'west':51 'with':23",
            "OCCUPANCYTYPE": "Comm",
            "ADDRESS": "175  W Boundary RD",
            "OWNER": "CITY OF BOSTON",
            "_id": 1,
            "Property_ID": "17268"
        }],
        "fields": [{
            "type": "int4",
            "id": "_id"
        }, {
            "type": "tsvector",
            "id": "_full_text"
        }, {
            "type": "text",
            "id": "PermitNumber"
        }, {
            "type": "text",
            "id": "WORKTYPE"
        }, {
            "type": "text",
            "id": "PermitTypeDescr"
        }, {
            "type": "text",
            "id": "DESCRIPTION"
        }, {
            "type": "text",
            "id": "Comments"
        }, {
            "type": "text",
            "id": "APPLICANT"
        }, {
            "type": "text",
            "id": "DECLARED_VALUATION"
        }, {
            "type": "text",
            "id": "TOTAL_FEES"
        }, {
            "type": "timestamp",
            "id": "ISSUED_DATE"
        }, {
            "type": "text",
            "id": "EXPIRATION_DATE"
        }, {
            "type": "text",
            "id": "STATUS"
        }, {
            "type": "text",
            "id": "OWNER"
        }, {
            "type": "text",
            "id": "OCCUPANCYTYPE"
        }, {
            "type": "text",
            "id": "sq_feet"
        }, {
            "type": "text",
            "id": "ADDRESS"
        }, {
            "type": "text",
            "id": "CITY"
        }, {
            "type": "text",
            "id": "STATE"
        }, {
            "type": "text",
            "id": "ZIP"
        }, {
            "type": "text",
            "id": "Property_ID"
        }, {
            "type": "text",
            "id": "Parcel_ID"
        }, {
            "type": "text",
            "id": "Location"
        }],
        "sql": "SELECT\n    *\nFROM \"6ddcd912-32a0-43df-9908-63574f8c7e77\"\nLIMIT 1;"
    }
}
-->
<!DOCTYPE html>
<html lang="en">
<head>
<title>SQL Client for data.boston.gov</title>
<style type="text/css" media="screen">
    :root {
        --editor-width:600px;
        --header-height:25px;
    }

    html {
        font-family: sans-serif;
    }
    body {
        margin: 0;
    }
    #header {
        height: var(--header-height);
        left: 0;
        right: 0;
        top: 0;
    }

    #editor { 
        position: absolute;
        top: var(--header-height);
        bottom: 0;
        left: 0;
        width:var(--editor-width);
    }

    #execute {
        position: absolute;
        top: var(--header-height);
        right: 0;
        margin-right: calc(100% - var(--editor-width));
        z-index: 2;
        border-collapse: collapse;
        border: 0;
        border-bottom: 3px solid #288BE4;
        padding:0;
        text-transform: uppercase;
        font-size: x-large;
        font-weight: bold;
    }

    #set {
        position: absolute;
        top: var(--header-height);
        right: 0;
        margin-right: calc((100% - var(--editor-width)) + 60px);
        z-index: 2;
    }

    #results {
        position: absolute;
        right:0;
        top: var(--header-height);
        bottom:0;
        width:calc(100% - var(--editor-width));
        border-collapse:collapse;
    }

    #results td {
        border:1px solid #efefef;
        padding:2px;
    }

    #results th {
        text-transform: uppercase;
        font-weight: normal;
        text-align: left;
        background-color: #efefef;
        padding:2px;
    }

    #results tr:nth-child(even) {
        background-color: #f9f7f7;
    }

    #results tr:hover {
        background-color: #efefef;
    }

    #results tr:focus {
        background-color: cyan;
    }

    div.lightbox {
    display: none;
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;z-index: 5;
}

div.lightbox:target {
    display: table;
}

div.lightbox figure {
    display: table-cell;
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    vertical-align: middle;
}

div.lightbox figure figcaption {
    display: block;
    margin: auto;
    padding: 8px;
    background-color: white;
    height: 75%;
    position: relative;
    overflow: auto;
    border: 1px #000000 solid;
    border-radius: 10px;
    text-align: justify;
    font-size: 14px;
}

div.lightbox figure .closemsg {
    display: block;
    margin: auto;
    height: 0;
    overflow: visible;
    text-align: right;
    z-index: 5001;
    cursor: default;
}

div.lightbox figure .closemsg, div.lightbox figure figcaption {
    width: 75%;
}

.closemsg::after {
    content: "\00D7";
    display: inline-block;
    position: relative;
    right: -20px;
    top: -10px;
    z-index: 5002;
    color: #ffffff;
    border: 1px #ffffff solid;
    border-radius: 10px;
    width: 20px;
    height: 20px;
    line-height: 18px;
    text-align: center;
    margin: 0;
    background-color: #000000;
    font-weight: bold;
    cursor: pointer;
}

.closemsg::before {
    content: "";
    display: block;
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: #000000;
    opacity: 0.85;
}
</style>
</head>
<body>
<div id="header">
    <a href="http://data.boston.gov"><img src="https://data.boston.gov/img/Analyze_Boston_logo.svg" style="height:20px;width:200px;vertical-align:middle;margin:2px;" border="0"></a> <span><strong>SQL Client</strong> by <a href="http://nattaylor.com" target="_blank">Nat Taylor</a></span> <span><a href="#help">Help</a></span>
</div>
<div id="editor">SELECT
    TO_CHAR("ISSUED_DATE", 'YYYY') AS YEAR,
    COUNT(*) PERMITS,
    COUNT(DISTINCT "Parcel_ID") PROPERTIES,
    SUM("DECLARED_VALUATION"::decimal) TOTAL_VALUE
FROM "6ddcd912-32a0-43df-9908-63574f8c7e77"
WHERE
    "ZIP" = '02128'
    AND "ADDRESS" NOT ILIKE '%%Harborside%%'
    AND "ADDRESS" NOT ILIKE '%%Logan%%'
    AND "ADDRESS" NOT ILIKE '%%Terminal%%'
    AND "DECLARED_VALUATION"::decimal < 500000
GROUP BY TO_CHAR("ISSUED_DATE", 'YYYY')
ORDER BY TO_CHAR("ISSUED_DATE", 'YYYY') ASC;</div>
<button id="execute">Run Query</button>
<!-- <button id="set">Set</button> -->
<div id="results"></div>
<div class="lightbox" id="help">
    <figure>
        <a href="#" class="closemsg"></a>
        <figcaption>
            <h1>Help</h1>
            <p><strong>Analyze Boston</strong> at <a href="">data.boston.gov</a> is "is the City of Boston's open data hub" with over 134 datasets and this Analyze Boston SQL Client is a tool for executing queries and displaying the results.</p>
            <h2>Usage</h2>
            <p>A dataset like <a href="https://data.boston.gov/dataset/property-assessment">Property Assesment</a> has a resource key which can be found in the preview link, like <code>https://data.boston.gov/dataset/property-assessment/resource/fd351943-c2c6-4630-992d-3f895360febd</code> on which you can run SQL.  This tool uses the SQL endpoint (<a href="http://docs.ckan.org/en/latest/maintaining/datastore.html#ckanext.datastore.logic.action.datastore_search_sql">documentation</a>.)</p>
            <h2>Troubleshooting</h2>
            <p>The tool uses CKAN DataStore, which is a thin layer on top of a PostgreSQL database, so the PostgreSQL docs are very helpful.  MySQL users may want to read <a href="https://wiki.postgresql.org/wiki/Things_to_find_out_about_when_moving_from_MySQL_to_PostgreSQL">Things to find out about when moving from MySQL to PostgreSQL</a>.  The tool will just say "error" when execute invalid SQL, because the DataStore extension does not give detailed error messages.  Common Problems Include: </p>
            <ul>
                <li>A system identifiers (e.g field names, table names, etc) wasn't <strong>doublequoted</strong></li>
                <li>A string wasn't <strong>single quoted</strong></li>
                <li>A nonexistent field was referenced</li>
                <li>A <code>::cast</code> failed</li>
            </ul>
        </figcaption>
    </figure>
</div>
<script src="src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="src-noconflict/ext-language_tools.js"></script>
<script>
    var editor = ace.edit("editor");
    
    //editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/sql");
    editor.renderer.setScrollMargin(10, 10, 10, 10);
    
    /*
    var langTools = ace.require("ace/ext/language_tools");
    editor.setOptions({
        enableBasicAutocompletion: true,
        enableSnippets: true,
        enableLiveAutocompletion: false
    });
    var rhymeCompleter = {
        getCompletions: function(editor, session, pos, prefix, callback) {
            if (prefix.length === 0) { callback(null, []); return }
            $.getJSON(
                "http://rhymebrain.com/talk?function=getRhymes&word=" + prefix,
                function(wordList) {
                    // wordList like [{"word":"flow","freq":24,"score":300,"flags":"bc","syllables":"1"}]
                    callback(null, wordList.map(function(ea) {
                        return {name: ea.word, value: ea.word, score: ea.score, meta: "rhyme"}
                    }));
                })
        }
    }
    langTools.addCompleter(rhymeCompleter);
    */
</script>
<script src="jquery-3.3.1.slim.min.js"></script>
<link rel="stylesheet" href="jquery.dataTables.min.css">
<script src="jquery.dataTables.min.js"></script>
<script>
    document.querySelector("#execute").addEventListener("click", execute);
    //document.querySelector("#set").addEventListener("click", setApiKey);
    var ENDPOINT = "https://data.boston.gov/api/3/action/datastore_search_sql?sql=";

    function setApiKey() {
        window.localStorage['secret'] = window.prompt('API Key')
    }

    function execute() {
        if (document.querySelector("#results") !== null) {
            document.body.removeChild(document.querySelector("#results"));
        }
        var oReq = new XMLHttpRequest();
        oReq.addEventListener("load", reqListener);
        oReq.addEventListener("error", transferFailed);
        oReq.open("GET", ENDPOINT+rawurlencode(editor.getValue()));
        //Not working
        if("secret" in localStorage) {
            oReq.setRequestHeader("Authorization",localStorage['secret']);
        }
        oReq.send();
    }

    function transferFailed() {
        alert("Query Failed - Common problems include:\n*Unquoted field\n*Cast error")
    }

    function reqListener() {
        results = JSON.parse(this.responseText)
        table = document.createElement("table");
        table.setAttribute("id","results");
        html = "<thead><tr>";
        for (var field of results.result.fields) {
            html += "<th>"+field.id+"</th>";
        }
        html += "</thead></tr>";
        for (var record of results.result.records) {
            html += "<tr>";
            for (var field of results.result.fields) {
                html += "<td>"+record[field.id]+"</td>";
            }
            html += "</tr>";
        }
        table.innerHTML = html;
        document.body.appendChild(table);
        //jQuery("#results").DataTable();
    }


    function rawurlencode (str) {
        str = (str+'').toString();        
        return encodeURIComponent(str).replace(/!/g, '%21').replace(/'/g, '%27').replace(/\(/g, '%28').replace(/\)/g, '%29').replace(/\*/g, '%2A');
    }
</script>
</body>
</html>